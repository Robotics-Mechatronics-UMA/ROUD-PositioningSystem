# Docker Multilateration - README

## Description
This project uses a Docker container to execute a multilateration workflow, including recording rosbags and analyzing the data using a Python script (`graphics.py`). Everything is managed by a launch script (`docker_launch.sh`) that automates the process and ensures it runs in a controlled environment.

## Requirements
Before starting, ensure you have the following installed:

- Docker
- Permissions to use X11 on the host system (for graphical visualization)
- Access to the project repository, which contains the necessary scripts.
- MATLAB

## Project Structure
The project is organized as follows:

```
ROUD_ps/
├── Code/
│   ├── Multilateration/
│   │   ├── server_ros_bridge.py
│   │   ├── ros_wrapper.py
│   │   ├── data_visualization.py
│   │   ├── positioning_rtt_ils.py
│   │   └── anchors_positions.py
├── Dataset/
│   ├── experiment_recording.bag
│   ├── raw_data.bag
│   └── Real_JEMERG23.sh
├── SARFIS/
│   ├── DEM files/
│   ├── Matlab functions/
│   │   ├── DEM/
│   │   ├── GPX/
│   │   ├── GUI/
│   │   └── ROS/
│   ├── resources/
│   ├── works/
│   └── SARFIS.prj
├── Figures/
├── Demo/
└── docker_launch.sh

```

- `Code/Multilateration/`: contains the multilateration algorithm and workflow to be applied on the provided dataset.
- `Dataset/`: contains the real data from the experiment and raw data to be processed offline.
- `SARFIS/Matlab functions/ROS/`: folder where new recorded rosbags are stored.
- `docker_launch.sh`: shell script used to automate tasks.

## Instructions

### 1. Initial Setup
Before launching the container:

1. Ensure the required files (e.g., `server_ros_bridge.py`, `ros_wrapper.py`, `data_visualization.py`, and `Real_JEMERG23.sh`) are present in the expected paths.
2. Verify that you have X11 access from Docker:
   ```bash
   xhost +local:root
   ```

### 2. Launch the Container
To launch the container and execute the workflow:

```bash
./docker_launch.sh OLS
```

Where `OLS` is the specified execution mode. You can replace `OLS` with another mode if supported by the `Real_JEMERG23.sh` script.

### 3. Automated Process
The `docker_launch.sh` script performs the following tasks:

1. Stops and removes any previous container with the name `ros1_multilateration`.
2. Launches a new interactive Docker container.
3. Executes the `Real_JEMERG23.sh` script, which includes:
   - Initializing `roscore`.
   - Playing an input rosbag.
   - Recording a new rosbag in the `SARFIS/Matlab functions/ROS/` folder.
4. Waits for all processes (e.g., rosbag play, recording) to complete.
5. Automatically detects the recorded rosbag and extracts its start time.
6. Executes the `data_visualization.py` script with the detected parameters.

### 4. Resulting Files
Workflow results include:
- A recorded rosbag file in `SARFIS/Matlab functions/ROS/`.
- Graphs generated by `data_visualization.py`.

### 5. Stopping the Container
The container will remain active after the workflow finishes. You can stop it manually with:

```bash
docker stop ros1_multilateration
```

### 6. Troubleshooting

#### Previous Container Still Running
If you see a message indicating the container is already running:

1. Stop it:
   ```bash
   docker rm -f ros1_multilateration
   ```

#### Notification File Not Created
If the script appears to hang waiting for the notification file (`/tmp/rosbag_record_done`):
1. Check the container logs:
   ```bash
   docker logs ros1_multilateration
   ```
2. Ensure that the `Real_JEMERG23.sh` script completes successfully and creates the notification file:
   ```bash
   touch /tmp/rosbag_record_done
   ```

#### Rosbag File Not Found
If the recorded rosbag file is not found:
1. Verify that the output directory is correctly configured:
   ```bash
   ls "SARFIS/Matlab functions/ROS/"
   ```
2. Check the directory permissions and container logs.

#### Processes Running in Background Block Graphics Execution
If the `graphics.py` script does not execute because background processes are still running:
1. Ensure all rosbag processes (e.g., `rosbag play`, `rosbag record`) have completed successfully.
2. Add a delay or synchronization mechanism in the script to wait for the processes to finish before executing `graphics.py`.
3. Check the container logs for errors:
   ```bash
   docker logs ros1_multilateration
   ```

### 7. Additional Notes
- To customize the workflow, modify the `Real_JEMERG23.sh` or `data_visualization.py` scripts as needed.
- If you need to add new execution modes, ensure the relevant scripts are updated accordingly.

### 8. Explanation of SARFIS Tool

The SARFIS tool requires two instances of MATLAB:

1. **First Instance:**
   - Start the master ROS node with `rosinit('localhost')`.
   - Create the ROS 1 publishers by executing the `ROSbag_play` function which is in the `SARFIS/Matlab functions/ROS/` folder.
   - Pause execution, waiting for the user to press ENTER after creating the subscribers in the second MATLAB instance.

2. **Second Instance:**
   - Open the SARFIS tool.
   - Connect to the master from the tool's interface (no need to specify the port; it defaults to 11311).
   - Create the 6 default agents using the `add` button. The associated subscribers are configured by default.
   - Create the subscriber associated with geolocation in the `Global Settings` tab.

3. **Final Step:**
   - Return to the first MATLAB instance and press ENTER.
   - Observe the recorded bag being replayed offline in the SARFIS tool.

